# -*- mode: ruby -*-
# vi: set ft=ruby :

# SUBSTITUIR ANTES DE USAR:
# - nome1, nome2: Primeiros nomes dos integrantes
# - XX: Dois últimos dígitos da matrícula do primeiro integrante
# - YY: Dois últimos dígitos da matrícula do segundo integrante
# - XY: Combinar últimos dígitos (ex: 2545 se matrículas terminam em 25 e 45)

Vagrant.configure("2") do |config|
  # Configuração comum para todas as VMs
  config.vm.box = "debian/bookworm64"
  config.vm.box_check_update = false
  
  # Desabilitar verificação de guest additions
  config.vbguest.auto_update = false
  
  # Desabilitar inserção de chave SSH (Vagrant 2.0+)
  config.ssh.insert_key = false
  
  # Configuração do provider VirtualBox
  config.vm.provider "virtualbox" do |vb|
    vb.linked_clone = true
    
    # Gatilho para desabilitar servidor DHCP do VirtualBox
    vb.customize ["modifyvm", :id, "--natdnshostresolver1", "off"]
    vb.customize ["modifyvm", :id, "--natdnsproxy1", "off"]
  end
  
  # ========== SERVIDOR DE ARQUIVOS (arq) ==========
  config.vm.define "arq" do |arq|
    # SUBSTITUIR: nome1 e nome2 pelos primeiros nomes
    arq.vm.hostname = "arq.nome1.nome2.devops"
    
    # SUBSTITUIR: XX pelos dois últimos dígitos da matrícula do primeiro integrante
    arq.vm.network "private_network", ip: "192.168.56.1XX"
    
    arq.vm.provider "virtualbox" do |vb|
      vb.memory = 512
      vb.name = "arq-devops"
      
      # Criar 3 discos adicionais de 10GB cada
      (1..3).each do |disk_num|
        disk_path = File.expand_path("disk-arq-#{disk_num}.vdi", File.dirname(__FILE__))
        
        unless File.exist?(disk_path)
          vb.customize ['createhd', 
                       '--filename', disk_path,
                       '--size', 10 * 1024,  # 10GB
                       '--variant', 'Standard']
        end
        
        vb.customize ['storageattach', :id,
                     '--storagectl', 'SATA Controller',
                     '--port', disk_num + 1,
                     '--device', '0',
                     '--type', 'hdd',
                     '--medium', disk_path]
      end
    end
    
    # Provisionamento com Ansible
    arq.vm.provision "ansible" do |ansible|
      ansible.playbook = "playbooks/arq.yml"
      ansible.become = true
      ansible.verbose = "v"
    end
  end
  
  # ========== SERVIDOR DE BANCO DE DADOS (db) ==========
  config.vm.define "db" do |db|
    # SUBSTITUIR: nome1 e nome2 pelos primeiros nomes
    db.vm.hostname = "db.nome1.nome2.devops"
    
    # Usar DHCP (o servidor arq fornecerá IP estático via MAC)
    # MAC específico para reserva DHCP
    db.vm.network "private_network", type: "dhcp",
      mac: "080027AAAAAA"
    
    db.vm.provider "virtualbox" do |vb|
      vb.memory = 512
      vb.name = "db-devops"
    end
    
    # Provisionamento com Ansible
    db.vm.provision "ansible" do |ansible|
      ansible.playbook = "playbooks/db.yml"
      ansible.become = true
      ansible.verbose = "v"
    end
  end
  
  # ========== SERVIDOR DE APLICAÇÃO (app) ==========
  config.vm.define "app" do |app|
    # SUBSTITUIR: nome1 e nome2 pelos primeiros nomes
    app.vm.hostname = "app.nome1.nome2.devops"
    
    # Usar DHCP (o servidor arq fornecerá IP estático via MAC)
    # MAC específico para reserva DHCP
    app.vm.network "private_network", type: "dhcp",
      mac: "080027BBBBBB"
    
    app.vm.provider "virtualbox" do |vb|
      vb.memory = 512
      vb.name = "app-devops"
    end
    
    # Provisionamento com Ansible
    app.vm.provision "ansible" do |ansible|
      ansible.playbook = "playbooks/app.yml"
      ansible.become = true
      ansible.verbose = "v"
    end
  end
  
  # ========== HOST CLIENTE (cli) ==========
  config.vm.define "cli" do |cli|
    # SUBSTITUIR: nome1 e nome2 pelos primeiros nomes
    cli.vm.hostname = "cli.nome1.nome2.devops"
    
    # Usar DHCP normal
    cli.vm.network "private_network", type: "dhcp"
    
    cli.vm.provider "virtualbox" do |vb|
      vb.memory = 1024  # 1GB RAM
      vb.name = "cli-devops"
    end
    
    # Provisionamento com Ansible
    cli.vm.provision "ansible" do |ansible|
      ansible.playbook = "playbooks/cli.yml"
      ansible.become = true
      ansible.verbose = "v"
    end
  end
end
